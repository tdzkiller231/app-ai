import React, { useState } from 'react';

// The main App component
export default function App() {
  const [prompt, setPrompt] = useState('');
  const [imageUrl, setImageUrl] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');

  // Function to generate image using the Gemini API
  const generateImage = async () => {
    setIsLoading(true);
    setError('');
    setImageUrl('');

    // Check if prompt is empty
    if (!prompt) {
      setError("Vui lòng nhập mô tả để tạo hình ảnh.");
      setIsLoading(false);
      return;
    }

    // API configuration for image generation
    const payload = {
      instances: {
        prompt: prompt
      },
      parameters: {
        "sampleCount": 1
      }
    };
    const apiKey = ""; // API key will be provided by the environment
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

    // Exponential backoff for API calls
    const makeApiCallWithBackoff = async (attempt = 0) => {
      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // If the response is not ok, throw an error
        if (!response.ok) {
          if (response.status === 429 && attempt < 5) {
            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
            console.log(`Đang thử lại sau ${delay}ms... (lần ${attempt + 1})`);
            await new Promise(res => setTimeout(res, delay));
            return makeApiCallWithBackoff(attempt + 1);
          }
          throw new Error(`Lỗi HTTP: ${response.status}`);
        }

        const result = await response.json();
        // Check if the response contains valid image data
        if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
          const base64Image = result.predictions[0].bytesBase64Encoded;
          setImageUrl(`data:image/png;base64,${base64Image}`);
        } else {
          throw new Error('Không thể tạo hình ảnh. Vui lòng thử lại với một mô tả khác.');
        }

      } catch (e) {
        console.error('Lỗi khi tạo hình ảnh:', e);
        setError(e.message);
      } finally {
        setIsLoading(false);
      }
    };

    makeApiCallWithBackoff();
  };

  return (
    <div className="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 p-4 sm:p-8 flex items-center justify-center font-[Inter]">
      <div className="w-full max-w-4xl mx-auto space-y-8">
        
        {/* Modern Header Section */}
        <div className="bg-white dark:bg-gray-800 rounded-3xl p-8 shadow-xl border border-gray-200 dark:border-gray-700">
          <div className="text-center space-y-4">
            <h1 className="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-purple-600">
              Chuyển văn bản thành hình ảnh
            </h1>
            <p className="text-lg text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
              Nhập mô tả của bạn và để AI tạo ra một hình ảnh tuyệt đẹp cho bạn.
            </p>
          </div>
          
          <div className="mt-8 flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
            {/* Prompt Input */}
            <input
              type="text"
              value={prompt}
              onChange={(e) => setPrompt(e.target.value)}
              placeholder="Ví dụ: Một con mèo cyborg đang cưỡi một chiếc xe đạp trong không gian"
              className="flex-1 p-4 rounded-xl border-2 border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all duration-300 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-gray-200 placeholder-gray-400 dark:placeholder-gray-500"
            />
            {/* Generate Button */}
            <button
              onClick={generateImage}
              disabled={isLoading}
              className="w-full sm:w-auto px-6 py-4 rounded-xl text-lg font-semibold text-white transition-all duration-300 transform active:scale-95
                         bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700
                         shadow-lg hover:shadow-xl disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:shadow-none disabled:cursor-not-allowed"
            >
              {isLoading ? 'Đang tạo...' : 'Tạo'}
            </button>
          </div>
        </div>

        {/* Image Display Section */}
        <div className="bg-white dark:bg-gray-800 rounded-3xl p-6 shadow-xl border border-gray-200 dark:border-gray-700">
          <div className="flex justify-center items-center w-full min-h-[350px] bg-gray-50 dark:bg-gray-700 rounded-2xl overflow-hidden relative">
            {isLoading && (
              <div className="flex flex-col items-center">
                <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-purple-500"></div>
                <p className="mt-4 text-gray-500 dark:text-gray-400">Đang tải, vui lòng đợi...</p>
              </div>
            )}
            {error && (
              <div className="text-center text-red-500 p-4">
                <p>⚠️ Lỗi:</p>
                <p>{error}</p>
              </div>
            )}
            {imageUrl && !isLoading && (
              <img
                src={imageUrl}
                alt="Hình ảnh được tạo bởi AI"
                className="w-full h-auto object-contain rounded-2xl"
              />
            )}
            {!imageUrl && !isLoading && !error && (
              <p className="text-gray-400 dark:text-gray-500">
                Hình ảnh sẽ xuất hiện tại đây sau khi bạn tạo.
              </p>
            )}
          </div>
        </div>

      </div>
    </div>
  );
}
